<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Discounting: Present Utility & Dynamic Consistency</title>

    <!-- Bootstrap 5.3.0 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- Shared Educational Styles -->
    <link rel="stylesheet" href="shared-bootstrap-edu.css">

    <!-- KaTeX CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">

    <style>
        /* App-specific styles */
        .pref-button {
            padding: 12px 30px;
            font-size: 1rem;
            font-weight: 600;
            border: 2px solid var(--base01);
            cursor: pointer;
            transition: all 0.3s;
            background: var(--base3);
            color: var(--base01);
        }

        .pref-button:hover {
            background: var(--base2);
        }

        .pref-button.selected {
            background: var(--blue);
            border-color: var(--blue);
            color: var(--base3);
        }

        .consistency-button {
            padding: 12px 40px;
            font-size: 1rem;
            font-weight: 600;
            border: 2px solid var(--base01);
            cursor: pointer;
            transition: all 0.3s;
            background: var(--base3);
            color: var(--base01);
        }

        .consistency-button:hover {
            background: var(--base2);
        }

        .consistency-button.selected {
            background: var(--blue);
            border-color: var(--blue);
            color: var(--base3);
        }

        .choice-display {
            background: var(--base3);
            border: 1px solid var(--base1);
            padding: 15px;
            margin: 10px 0;
            border-radius: 4px;
        }

        .utility-equation {
            font-size: 1rem;
            margin: 8px 0;
            padding-left: 20px;
        }
    </style>
</head>
<body>
    <div class="container mt-4" data-app="discounting-consistency">
        <!-- Header with utility buttons -->
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h1 class="mb-0">Discounting & Dynamic Consistency</h1>
            <div class="btn-toolbar gap-1">
                <button class="btn btn-sm btn-outline-secondary" onclick="expandAll()">Expand All</button>
                <button class="btn btn-sm btn-outline-secondary" onclick="collapseAll()">Collapse All</button>
                <button class="btn btn-sm btn-outline-secondary" onclick="resetApp()">Reset</button>
                <button class="btn btn-sm btn-outline-secondary" onclick="window.print()">Print</button>
            </div>
        </div>

        <!-- Instructor Info -->
        <div class="edu-instructor-info">
            <p><strong>Instructor:</strong> Sérgio O. Parreiras</p>
            <p><strong>Course:</strong> ECON 510 - Advanced Microeconomic Theory</p>
        </div>

        <!-- Main content (dynamically updated) -->
        <div id="main-content">
            <!-- Content will be dynamically updated based on state -->
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <!-- KaTeX JS -->
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>

    <script>
        // Global variables
        let currentProblem = {
            U: null,
            V: null,
            discountParams: null,
            k: null,
            puU: null,
            puV: null,
            correctPreference: null
        };

        let userPreference = null;
        let userConsistencyAnswer = null;
        let k = -1;
        let uu = null;
        let vv = null;
        let storedDelta = null;
        let storedAlpha = null;
        let storedBeta = null;

        // Store user choices for consistency check
        let storedChoices = {
            k0: { choice: null, puU: null, puV: null, U: null, V: null },
            k1: { choice: null, puU: null, puV: null, U: null, V: null },
            k3: { choice: null, puU: null, puV: null, U: null, V: null },
            k4: { choice: null, puU: null, puV: null, U: null, V: null }
        };

        // Flow generation functions
        function generateU() {
            return {
                u0: Math.floor(Math.random() * 101),
                u1: Math.floor(Math.random() * 101),
                u2: Math.floor(Math.random() * 51) + 50
            };
        }

        function generateV(u) {
            const v0 = u.u0;
            const v1 = u.u1 + 1 + Math.floor(Math.random() * 21);
            const lowerBound = 3*u.u1 + u.u2 - 3*v1;
            const upperBound = Math.floor((1/2) * (3*u.u1 + 2*u.u2 - 3*v1));
            const v2 = lowerBound + Math.floor(Math.random() * (upperBound - lowerBound + 1));
            return { v0, v1, v2 };
        }

        // Utility calculation functions
        function calculateExponentialUtility(flow, delta) {
            return flow[0] + delta * flow[1] + delta * delta * flow[2];
        }

        function calculateHyperbolicUtility(flow, alpha, beta) {
            let utility = flow[0];
            utility += flow[1] * Math.pow(1 + alpha * 1, -beta / alpha);
            utility += flow[2] * Math.pow(1 + alpha * 2, -beta / alpha);
            return utility;
        }

        function generateNewProblem() {
            const previousK = k;
            k = (k + 1) % 6;

            // Store user choice before advancing
            if (previousK === 0 && userPreference !== null) {
                storedChoices.k0 = {
                    choice: userPreference,
                    puU: currentProblem.puU,
                    puV: currentProblem.puV,
                    U: [...currentProblem.U],
                    V: [...currentProblem.V]
                };
            } else if (previousK === 1 && userPreference !== null) {
                storedChoices.k1 = {
                    choice: userPreference,
                    puU: currentProblem.puU,
                    puV: currentProblem.puV,
                    U: [...currentProblem.U],
                    V: [...currentProblem.V]
                };
            } else if (previousK === 3 && userPreference !== null) {
                storedChoices.k3 = {
                    choice: userPreference,
                    puU: currentProblem.puU,
                    puV: currentProblem.puV,
                    U: [...currentProblem.U],
                    V: [...currentProblem.V]
                };
            } else if (previousK === 4 && userPreference !== null) {
                storedChoices.k4 = {
                    choice: userPreference,
                    puU: currentProblem.puU,
                    puV: currentProblem.puV,
                    U: [...currentProblem.U],
                    V: [...currentProblem.V]
                };
            }

            // Skip k=2 if choices missing
            if (k === 2 && (storedChoices.k0.choice === null || storedChoices.k1.choice === null)) {
                k = 3;
            }

            // Skip k=5 if choices missing
            if (k === 5 && (storedChoices.k3.choice === null || storedChoices.k4.choice === null)) {
                k = 0;
            }

            // Clear stored choices when entering k=0
            if (k === 0) {
                storedChoices = {
                    k0: { choice: null, puU: null, puV: null, U: null, V: null },
                    k1: { choice: null, puU: null, puV: null, U: null, V: null },
                    k3: { choice: null, puU: null, puV: null, U: null, V: null },
                    k4: { choice: null, puU: null, puV: null, U: null, V: null }
                };
            }

            let U, V, discountParams;

            // Generate flows at k=0
            if (k === 0) {
                const u_dict = generateU();
                const v_dict = generateV(u_dict);
                uu = [u_dict.u0, u_dict.u1, u_dict.u2];
                vv = [v_dict.v0, v_dict.v1, v_dict.v2];
                storedDelta = 0.3 + Math.random() * 0.2;
            }

            // Generate hyperbolic parameters at k=3
            if (k === 3) {
                storedAlpha = 0.4 + Math.random() * 1.0;
                storedBeta = -Math.log(storedDelta);
            }

            switch(k) {
                case 0:
                    U = [uu[0], uu[1], uu[2]];
                    V = [vv[0], vv[1], vv[2]];
                    discountParams = { type: 'exponential', delta: storedDelta };
                    break;
                case 1:
                    U = [uu[1], uu[2], 0];
                    V = [vv[1], vv[2], 0];
                    discountParams = { type: 'exponential', delta: storedDelta };
                    break;
                case 2:
                    discountParams = { type: 'consistency-exponential', delta: storedDelta };
                    break;
                case 3:
                    U = [uu[0], uu[1], uu[2]];
                    V = [vv[0], vv[1], vv[2]];
                    discountParams = { type: 'hyperbolic', alpha: storedAlpha, beta: storedBeta };
                    break;
                case 4:
                    U = [uu[1], uu[2], 0];
                    V = [vv[1], vv[2], 0];
                    discountParams = { type: 'hyperbolic', alpha: storedAlpha, beta: storedBeta };
                    break;
                case 5:
                    discountParams = { type: 'consistency-hyperbolic', alpha: storedAlpha, beta: storedBeta };
                    break;
            }

            // Calculate utilities (skip for consistency states)
            if (k !== 2 && k !== 5) {
                let puU, puV;
                if (discountParams.type === 'exponential') {
                    puU = calculateExponentialUtility(U, discountParams.delta);
                    puV = calculateExponentialUtility(V, discountParams.delta);
                } else {
                    puU = calculateHyperbolicUtility(U, discountParams.alpha, discountParams.beta);
                    puV = calculateHyperbolicUtility(V, discountParams.alpha, discountParams.beta);
                }

                currentProblem = {
                    U, V, discountParams, k,
                    puU: puU,
                    puV: puV,
                    correctPreference: puU > puV ? 'u' : 'v'
                };
            } else {
                currentProblem = {
                    U: null, V: null, discountParams, k,
                    puU: null, puV: null, correctPreference: null
                };
            }

            updateDisplay();
            clearInputs();
        }

        function updateDisplay() {
            if (currentProblem.discountParams.type.startsWith('consistency')) {
                updateConsistencyDisplay();
            } else {
                updateNormalDisplay();
            }
        }

        function updateNormalDisplay() {
            const content = document.getElementById('main-content');
            const isExponential = currentProblem.discountParams.type === 'exponential';

            let paramsDisplay, formulaDisplay;
            if (isExponential) {
                paramsDisplay = `$\\delta = ${currentProblem.discountParams.delta.toFixed(3)}$`;
                formulaDisplay = `$U_0 = u_0 + \\delta \\cdot u_1 + \\delta^2 \\cdot u_2$`;
            } else {
                paramsDisplay = `$\\alpha = ${currentProblem.discountParams.alpha.toFixed(3)} \\quad \\beta = ${currentProblem.discountParams.beta.toFixed(3)}$`;
                formulaDisplay = `$U_0 = u_0 + (1+\\alpha)^{-\\beta/\\alpha} u_1 + (1+2\\alpha)^{-\\beta/\\alpha} u_2$`;
            }

            content.innerHTML = `
                <div class="accordion" id="mainAccordion">
                    <!-- Problem Setup -->
                    <div class="accordion-item">
                        <h2 class="accordion-header">
                            <button class="accordion-button" type="button"
                                    data-bs-toggle="collapse" data-bs-target="#problemSection">
                                Problem Setup
                            </button>
                        </h2>
                        <div id="problemSection" class="accordion-collapse collapse show">
                            <div class="accordion-body">
                                <div class="edu-two-column">
                                    <div class="card">
                                        <div class="card-header">Flow U</div>
                                        <div class="card-body text-center">
                                            <div class="edu-flow-display">$U = (${currentProblem.U[0]}, ${currentProblem.U[1]}, ${currentProblem.U[2]})$</div>
                                        </div>
                                    </div>
                                    <div class="card">
                                        <div class="card-header">Flow V</div>
                                        <div class="card-body text-center">
                                            <div class="edu-flow-display">$V = (${currentProblem.V[0]}, ${currentProblem.V[1]}, ${currentProblem.V[2]})$</div>
                                        </div>
                                    </div>
                                </div>

                                <div class="edu-question">
                                    <strong>${isExponential ? 'Discount Factor' : 'Hyperbolic Parameters'}:</strong> ${paramsDisplay}
                                </div>

                                <div class="edu-formula">
                                    ${formulaDisplay}
                                </div>

                                <div class="text-center mt-3">
                                    <button class="btn btn-primary" onclick="generateNewProblem()">New Problem</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Your Calculations -->
                    <div class="accordion-item">
                        <h2 class="accordion-header">
                            <button class="accordion-button" type="button"
                                    data-bs-toggle="collapse" data-bs-target="#answersSection">
                                Your Calculations
                            </button>
                        </h2>
                        <div id="answersSection" class="accordion-collapse collapse show">
                            <div class="accordion-body">
                                <div class="card-body d-flex flex-column align-items-center">
                                    <div class="d-flex align-items-center mb-2">
                                        <label class="me-2">$PU(U)$:</label>
                                        <input type="number" step="0.01" class="form-control" style="width: 150px;" id="pv-u-input">
                                    </div>
                                    <div class="d-flex align-items-center mb-2">
                                        <label class="me-2">$PU(V)$:</label>
                                        <input type="number" step="0.01" class="form-control" style="width: 150px;" id="pv-v-input">
                                    </div>
                                </div>

                                <div class="edu-question">
                                    <h6>Which flow do you prefer?</h6>
                                    <div class="d-flex gap-3 justify-content-center mt-3">
                                        <button class="pref-button" id="prefer-u">Flow U</button>
                                        <button class="pref-button" id="prefer-v">Flow V</button>
                                    </div>
                                </div>

                                <div class="text-center mt-3">
                                    <button class="btn btn-primary" onclick="checkAnswers()">Check Answers</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Solution -->
                    <div class="accordion-item">
                        <h2 class="accordion-header">
                            <button class="accordion-button collapsed" type="button"
                                    data-bs-toggle="collapse" data-bs-target="#solutionSection">
                                Solution
                            </button>
                        </h2>
                        <div id="solutionSection" class="accordion-collapse collapse">
                            <div class="accordion-body">
                                <div id="feedback"></div>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            // Add event listeners for preference buttons
            document.getElementById('prefer-u').addEventListener('click', function() {
                userPreference = 'u';
                document.getElementById('prefer-u').classList.add('selected');
                document.getElementById('prefer-v').classList.remove('selected');
            });

            document.getElementById('prefer-v').addEventListener('click', function() {
                userPreference = 'v';
                document.getElementById('prefer-v').classList.add('selected');
                document.getElementById('prefer-u').classList.remove('selected');
            });

            // Render KaTeX
            renderMathInElement(content, {
                delimiters: [
                    {left: '$$', right: '$$', display: true},
                    {left: '$', right: '$', display: false}
                ],
                throwOnError: false
            });
        }

        function updateConsistencyDisplay() {
            const content = document.getElementById('main-content');
            const isExponential = currentProblem.discountParams.type === 'consistency-exponential';
            const choice0 = isExponential ? storedChoices.k0 : storedChoices.k3;
            const choice1 = isExponential ? storedChoices.k1 : storedChoices.k4;

            const flow0U = choice0.U;
            const flow0V = choice0.V;
            const flow1U = choice1.U;
            const flow1V = choice1.V;

            const chosen0 = choice0.choice === 'u' ? flow0U : flow0V;
            const chosen1 = choice1.choice === 'u' ? flow1U : flow1V;

            const ineq0 = choice0.choice === 'u' ? '>' : '<';
            const ineq1 = choice1.choice === 'u' ? '>' : '<';

            content.innerHTML = `
                <div class="accordion" id="mainAccordion">
                    <!-- Problem Setup -->
                    <div class="accordion-item">
                        <h2 class="accordion-header">
                            <button class="accordion-button" type="button"
                                    data-bs-toggle="collapse" data-bs-target="#problemSection">
                                Dynamic Consistency Check
                            </button>
                        </h2>
                        <div id="problemSection" class="accordion-collapse collapse show">
                            <div class="accordion-body">
                                <div class="choice-display">
                                    <strong>Choice 1 (at $t=0$):</strong> Between $(${flow0U[0]}, ${flow0U[1]}, ${flow0U[2]})$ and $(${flow0V[0]}, ${flow0V[1]}, ${flow0V[2]})$, you chose $(${chosen0[0]}, ${chosen0[1]}, ${chosen0[2]})$.
                                    <div class="utility-equation">
                                        $U_0(${flow0U[0]}, ${flow0U[1]}, ${flow0U[2]}) = ${choice0.puU.toFixed(3)} ${ineq0} U_0(${flow0V[0]}, ${flow0V[1]}, ${flow0V[2]}) = ${choice0.puV.toFixed(3)}$
                                    </div>
                                </div>

                                <div class="choice-display">
                                    <strong>Choice 2 (at $t=1$):</strong> Between $(${flow1U[0]}, ${flow1U[1]}, ${flow1U[2]})$ and $(${flow1V[0]}, ${flow1V[1]}, ${flow1V[2]})$, you chose $(${chosen1[0]}, ${chosen1[1]}, ${chosen1[2]})$.
                                    <div class="utility-equation">
                                        $U_0(${flow1U[0]}, ${flow1U[1]}, ${flow1U[2]}) = ${choice1.puU.toFixed(3)} ${ineq1} U_0(${flow1V[0]}, ${flow1V[1]}, ${flow1V[2]}) = ${choice1.puV.toFixed(3)}$
                                    </div>
                                </div>

                                <div class="text-center mt-3">
                                    <button class="btn btn-primary" onclick="generateNewProblem()">New Problem</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Your Answer -->
                    <div class="accordion-item">
                        <h2 class="accordion-header">
                            <button class="accordion-button" type="button"
                                    data-bs-toggle="collapse" data-bs-target="#answersSection">
                                Your Answer
                            </button>
                        </h2>
                        <div id="answersSection" class="accordion-collapse collapse show">
                            <div class="accordion-body">
                                <div class="edu-question">
                                    <h6>Are these choices dynamically consistent?</h6>
                                    <div class="d-flex gap-3 justify-content-center mt-3">
                                        <button class="consistency-button" id="consistency-yes">YES</button>
                                        <button class="consistency-button" id="consistency-no">NO</button>
                                    </div>
                                </div>

                                <div class="text-center mt-3">
                                    <button class="btn btn-primary" onclick="checkConsistencyAnswer()">Check Answer</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Solution -->
                    <div class="accordion-item">
                        <h2 class="accordion-header">
                            <button class="accordion-button collapsed" type="button"
                                    data-bs-toggle="collapse" data-bs-target="#solutionSection">
                                Solution
                            </button>
                        </h2>
                        <div id="solutionSection" class="accordion-collapse collapse">
                            <div class="accordion-body">
                                <div id="feedback"></div>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            // Add event listeners
            document.getElementById('consistency-yes').addEventListener('click', function() {
                userConsistencyAnswer = 'yes';
                document.getElementById('consistency-yes').classList.add('selected');
                document.getElementById('consistency-no').classList.remove('selected');
            });

            document.getElementById('consistency-no').addEventListener('click', function() {
                userConsistencyAnswer = 'no';
                document.getElementById('consistency-no').classList.add('selected');
                document.getElementById('consistency-yes').classList.remove('selected');
            });

            // Render KaTeX
            renderMathInElement(content, {
                delimiters: [
                    {left: '$$', right: '$$', display: true},
                    {left: '$', right: '$', display: false}
                ],
                throwOnError: false
            });
        }

        function clearInputs() {
            userPreference = null;
            userConsistencyAnswer = null;
        }

        function buildSolutionHTML() {
            if (!currentProblem.U) return '';

            let solution = '<div class="edu-code">';
            solution += `<strong>Complete Solution</strong><br><br>`;
            solution += `<strong>Given:</strong><br>`;
            solution += `Flow $U = (${currentProblem.U[0]}, ${currentProblem.U[1]}, ${currentProblem.U[2]})$<br>`;
            solution += `Flow $V = (${currentProblem.V[0]}, ${currentProblem.V[1]}, ${currentProblem.V[2]})$<br><br>`;

            if (currentProblem.discountParams.type === 'exponential') {
                const δ = currentProblem.discountParams.delta;
                solution += `$\\delta = ${δ.toFixed(3)}$<br><br>`;
                solution += `<strong>Calculations:</strong><br>`;
                solution += `$PU(U) = ${currentProblem.U[0]} + ${δ.toFixed(3)} \\times ${currentProblem.U[1]} + ${δ.toFixed(3)}^2 \\times ${currentProblem.U[2]}$<br>`;
                solution += `$PU(U) = ${currentProblem.U[0]} + ${(δ * currentProblem.U[1]).toFixed(3)} + ${(δ * δ * currentProblem.U[2]).toFixed(3)} = ${currentProblem.puU.toFixed(3)}$<br><br>`;
                solution += `$PU(V) = ${currentProblem.V[0]} + ${δ.toFixed(3)} \\times ${currentProblem.V[1]} + ${δ.toFixed(3)}^2 \\times ${currentProblem.V[2]}$<br>`;
                solution += `$PU(V) = ${currentProblem.V[0]} + ${(δ * currentProblem.V[1]).toFixed(3)} + ${(δ * δ * currentProblem.V[2]).toFixed(3)} = ${currentProblem.puV.toFixed(3)}$<br>`;
            } else {
                const α = currentProblem.discountParams.alpha;
                const β = currentProblem.discountParams.beta;
                const d1 = Math.pow(1 + α * 1, -β / α);
                const d2 = Math.pow(1 + α * 2, -β / α);

                solution += `$\\alpha = ${α.toFixed(3)}, \\quad \\beta = ${β.toFixed(3)}$<br><br>`;
                solution += `<strong>Discount factors:</strong><br>`;
                solution += `$(1+\\alpha)^{-\\beta/\\alpha} = ${d1.toFixed(3)}$<br>`;
                solution += `$(1+2\\alpha)^{-\\beta/\\alpha} = ${d2.toFixed(3)}$<br><br>`;
                solution += `<strong>Calculations:</strong><br>`;
                solution += `$PU(U) = ${currentProblem.U[0]} + ${d1.toFixed(3)} \\times ${currentProblem.U[1]} + ${d2.toFixed(3)} \\times ${currentProblem.U[2]}$<br>`;
                solution += `$PU(U) = ${currentProblem.U[0]} + ${(d1 * currentProblem.U[1]).toFixed(3)} + ${(d2 * currentProblem.U[2]).toFixed(3)} = ${currentProblem.puU.toFixed(3)}$<br><br>`;
                solution += `$PU(V) = ${currentProblem.V[0]} + ${d1.toFixed(3)} \\times ${currentProblem.V[1]} + ${d2.toFixed(3)} \\times ${currentProblem.V[2]}$<br>`;
                solution += `$PU(V) = ${currentProblem.V[0]} + ${(d1 * currentProblem.V[1]).toFixed(3)} + ${(d2 * currentProblem.V[2]).toFixed(3)} = ${currentProblem.puV.toFixed(3)}$<br>`;
            }

            solution += `<br><strong>Conclusion:</strong><br>`;
            solution += `Since $PU(${currentProblem.correctPreference.toUpperCase()}) = ${Math.max(currentProblem.puU, currentProblem.puV).toFixed(3)} > ${Math.min(currentProblem.puU, currentProblem.puV).toFixed(3)}$,<br>`;
            solution += `the preferred flow is <strong>Flow ${currentProblem.correctPreference.toUpperCase()}</strong>.`;
            solution += '</div>';

            return solution;
        }

        function buildConsistencySolutionHTML() {
            const isExponential = currentProblem.discountParams.type === 'consistency-exponential';
            const choice0 = isExponential ? storedChoices.k0 : storedChoices.k3;
            const choice1 = isExponential ? storedChoices.k1 : storedChoices.k4;

            const flow0U = choice0.U;
            const flow0V = choice0.V;
            const flow1U = choice1.U;
            const flow1V = choice1.V;

            const isConsistent = choice0.choice === choice1.choice;
            const correctAnswer = isConsistent ? 'YES' : 'NO';

            let solution = '<div class="edu-code">';
            solution += `<strong>Solution</strong><br><br>`;
            solution += `The flows are constructed so that:<br>`;
            solution += `- At $t=0$: flows $(${flow0U[0]}, ${flow0U[1]}, ${flow0U[2]})$ and $(${flow0V[0]}, ${flow0V[1]}, ${flow0V[2]})$ represent two options, where $u_0 = v_0$<br>`;
            solution += `- At $t=1$: flows $(${flow1U[0]}, ${flow1U[1]}, ${flow1U[2]})$ and $(${flow1V[0]}, ${flow1V[1]}, ${flow1V[2]})$ are the same flows after one period elapses<br><br>`;
            solution += `Since both flows share the same initial value $u_0 = v_0$, your choice at $t=0$ depends entirely on your preferences over $(${flow0U[1]}, ${flow0U[2]})$ versus $(${flow0V[1]}, ${flow0V[2]})$. At $t=1$, you face the same comparison.<br><br>`;
            solution += `<strong>Your choices:</strong><br>`;
            solution += `- At $t=0$: You chose flow $(${choice0.choice === 'u' ? flow0U.join(', ') : flow0V.join(', ')})$<br>`;
            solution += `- At $t=1$: You chose flow $(${choice1.choice === 'u' ? flow1U.join(', ') : flow1V.join(', ')})$<br><br>`;

            if (isConsistent) {
                solution += `You chose the same flow in both periods. Your choices are <strong>dynamically consistent: YES</strong>.`;
            } else {
                solution += `You chose different flows in the two periods. Your choices are <strong>NOT dynamically consistent: NO</strong>.`;
            }

            solution += '</div>';
            return solution;
        }

        function checkAnswers() {
            if (!currentProblem.U) {
                alert('Please generate a new problem first!');
                return;
            }

            const userPuU = parseFloat(document.getElementById('pv-u-input').value);
            const userPuV = parseFloat(document.getElementById('pv-v-input').value);

            if (isNaN(userPuU) || isNaN(userPuV)) {
                showFeedback('Please enter valid numbers for both present utilities!', 'error');
                return;
            }

            if (userPreference === null) {
                showFeedback('Please select your preferred flow!', 'error');
                return;
            }

            const tolerance = 0.1;
            const puUCorrect = Math.abs(userPuU - currentProblem.puU) <= tolerance;
            const puVCorrect = Math.abs(userPuV - currentProblem.puV) <= tolerance;
            const preferenceCorrect = userPreference === currentProblem.correctPreference;

            let feedback = '';
            let feedbackType = '';

            if (puUCorrect && puVCorrect && preferenceCorrect) {
                feedback = '<strong>Excellent!</strong> All answers are correct!';
                feedbackType = 'success';
            } else {
                feedback = '<strong>Some answers need correction:</strong><br><br>';

                if (!puUCorrect) {
                    feedback += `$PU(U)$: Your answer ${userPuU.toFixed(3)} should be ${currentProblem.puU.toFixed(3)}<br>`;
                } else {
                    feedback += `$PU(U)$: Correct!<br>`;
                }

                if (!puVCorrect) {
                    feedback += `$PU(V)$: Your answer ${userPuV.toFixed(3)} should be ${currentProblem.puV.toFixed(3)}<br>`;
                } else {
                    feedback += `$PU(V)$: Correct!<br>`;
                }

                if (!preferenceCorrect) {
                    feedback += `Preference: You chose Flow ${userPreference.toUpperCase()}, but Flow ${currentProblem.correctPreference.toUpperCase()} has higher present utility<br>`;
                } else {
                    feedback += `Preference: Correct!<br>`;
                }

                feedbackType = (puUCorrect || puVCorrect || preferenceCorrect) ? 'warning' : 'error';
            }

            feedback += '<br>' + buildSolutionHTML();
            showFeedback(feedback, feedbackType);
        }

        function checkConsistencyAnswer() {
            if (userConsistencyAnswer === null) {
                showFeedback('Please select YES or NO!', 'error');
                return;
            }

            const isExponential = currentProblem.discountParams.type === 'consistency-exponential';
            const choice0 = isExponential ? storedChoices.k0 : storedChoices.k3;
            const choice1 = isExponential ? storedChoices.k1 : storedChoices.k4;

            const isConsistent = choice0.choice === choice1.choice;
            const correctAnswer = isConsistent ? 'yes' : 'no';

            let feedback = '';
            let feedbackType = '';

            if (userConsistencyAnswer === correctAnswer) {
                feedback = '<strong>Excellent!</strong> Your answer is correct!';
                feedbackType = 'success';
            } else {
                feedback = `<strong>Your answer is incorrect.</strong> The correct answer is: ${correctAnswer.toUpperCase()}`;
                feedbackType = 'error';
            }

            feedback += '<br><br>' + buildConsistencySolutionHTML();
            showFeedback(feedback, feedbackType);
        }

        function showFeedback(message, type) {
            const feedback = document.getElementById('feedback');
            feedback.innerHTML = message;
            const classMap = {
                'success': 'edu-success',
                'error': 'edu-error',
                'warning': 'edu-warning',
                'code': 'edu-code'
            };
            feedback.className = classMap[type] || 'edu-success';

            // Auto-expand solution section
            const solutionSection = document.getElementById('solutionSection');
            if (solutionSection) {
                new bootstrap.Collapse(solutionSection, {toggle: false}).show();
            }

            // Render KaTeX in feedback
            renderMathInElement(feedback, {
                delimiters: [
                    {left: '$$', right: '$$', display: true},
                    {left: '$', right: '$', display: false}
                ],
                throwOnError: false
            });
        }

        // Utility functions
        function expandAll() {
            document.querySelectorAll('.accordion-collapse').forEach(el => {
                new bootstrap.Collapse(el, {toggle: false}).show();
            });
        }

        function collapseAll() {
            document.querySelectorAll('.accordion-collapse').forEach(el => {
                new bootstrap.Collapse(el, {toggle: false}).hide();
            });
        }

        function resetApp() {
            document.querySelectorAll('input[type="number"], input[type="text"]').forEach(i => i.value = '');
            document.getElementById('feedback').innerHTML = '';
            document.getElementById('feedback').className = '';
            document.querySelectorAll('.pref-button, .consistency-button').forEach(b => b.classList.remove('selected'));
            userPreference = null;
            userConsistencyAnswer = null;
        }

        // Initialize on page load
        window.addEventListener('load', function() {
            setTimeout(function() {
                generateNewProblem();
            }, 100);
        });
    </script>
</body>
</html>
